@model TypiconEntityEditModel
@{
    ViewData["Title"] = "Редактирование Устава";
}

<div class="container">
    <ul class="nav nav-tabs">
        <li class="active"><a data-toggle="tab" href="#panel_properties">Свойства</a></li>
        <li><a data-toggle="tab" href="#panel_jobs">Операции</a></li>
        @if (ViewBag.IsAuthor)
        {
            <li><a data-toggle="tab" href="#panel_editors">Редакторы</a></li>
        }
        <li><a asp-controller="TypiconVariables" asp-action="Index" asp-route-id="@Model.Id">Переменные</a></li>
        <li class="dropdown">
            <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                Редактирование Правил
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li><a asp-controller="Sign" asp-action="Index" asp-route-id="@Model.Id">Знаки служб</a></li>
                <li><a asp-controller="MenologyRule" asp-action="Index" asp-route-id="@Model.Id">Правила Минеи</a></li>
                <li><a asp-controller="TriodionRule" asp-action="Index" asp-route-id="@Model.Id">Правила Триоди</a></li>
                <li><a asp-controller="CommonRule" asp-action="Index" asp-route-id="@Model.Id">Общие Правила</a></li>
                <li><a asp-controller="ExplicitAddRule" asp-action="Index" asp-route-id="@Model.Id">Явные Правила</a></li>
                <li><a asp-controller="Kathisma" asp-action="Index" asp-route-id="@Model.Id">Кафизмы</a></li>
            </ul>
        </li>
    </ul>
    <div class="tab-content">
        <div id="panel_properties" class="tab-pane fade in active">
            <div class="col-md-8">
                <h2>Редактирование свойств Устава</h2>
            </div>
            <div class="clearfix"></div>
            <form asp-action="Edit" method="post">
                <div asp-validation-summary="All" class="text-danger"></div>
                <div class="col-md-8">
                    <div class="table-title">
                        <div class="row">
                            <div class="col-sm-9"><label asp-for="Name">Наименование</label></div>
                            <div class="col-sm-3 text-right">
                                <button type="button" class="btn btn-info add-new btn-xs"><i class="fa fa-plus"></i> Добавить</button>
                            </div>
                        </div>
                    </div>
                    <table id="itemtext" class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Язык</th>
                                <th>Значение</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.Name.Items.Count; i++)
                            {
                                <tr>
                                    <td class="language">@Model.Name.Items[i].Language</td>
                                    <td class="text">@Model.Name.Items[i].Text</td>
                                    <td>
                                        <input class="language" type="hidden" asp-for="@Model.Name.Items[i].Language" />
                                        <input class="text" type="hidden" asp-for="@Model.Name.Items[i].Text" />
                                        <a class="add" title="Add" data-toggle="tooltip"><i class="material-icons">&#xE03B;</i></a>
                                        <a class="edit" title="Edit" data-toggle="tooltip"><i class="material-icons">&#xE254;</i></a>
                                        <a class="delete" title="Delete" data-toggle="tooltip"><i class="material-icons">&#xE872;</i></a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="clearfix"></div>
                <div class="form-group col-sm-8">
                    <label asp-for="IsTemplate">Является ли Шаблоном</label>
                    <p>
                        Если является Шаблоном то: Может быть опубликован с наличием незаполненных Переменных Устава,
                        будет использоваться только в качестве образца для создания новых Уставов, будет недоступен для просмотра расписания.
                    </p>
                    <input type="radio" asp-for="IsTemplate" value="true" id="IsTemplateTrue" />Шаблон<br />
                    <input type="radio" asp-for="IsTemplate" value="false" id="IsTemplateFalse" />Обычный Устав<br />
                    <span asp-validation-for="IsTemplate" class="text-danger"></span>
                </div>
                <div class="clearfix"></div>
                <div class="form-group col-sm-8">
                    <label asp-for="DefaultLanguage">Язык по умолчанию</label>
                    <input asp-for="DefaultLanguage" class="form-control" />
                    <span asp-validation-for="DefaultLanguage" class="text-danger"></span>
                </div>
                <div class="clearfix"></div>
                <div class="form-group"><div class="validation" asp-validation-summary="ModelOnly"></div></div>
                <div class="clearfix"></div>
                <div class="col-xs-12">
                    <button class="btn btn-primary" asp-action="Edit" asp-route-id="@Model.Id">Сохранить</button>
                </div>
            </form>
        </div>
        <div id="panel_jobs" class="tab-pane fade">
            <div class="col-md-8">
                <h2>Операции над Уставом</h2>
            </div>
            <div class="clearfix"></div>
            <div class="form-group col-sm-8">
                @{
                    var pblDisabled = !Model.IsModified || (!Model.IsTemplate && Model.HasVariables);
                }
                <a class="btn btn-primary" asp-action="Publish" asp-route-id="@Model.Id" disabled="@(pblDisabled ? " disabled" : null)">Опубликовать черновик Устава</a>
            </div>
            <div class="form-group col-sm-8">
                @if (pblDisabled)
                {
                    <div class="panel panel-danger">
                        <div class="panel-heading">
                            <h3 class="panel-title">Публикация не доступна по следующим причинам</h3>
                        </div>
                        <div class="panel-body">
                            @if (!Model.IsModified)
                            {
                                <div class="clearfix"></div>
                                <div class="form-group col-md-6">Не было внесено изменений в черновик Устава.</div>
                            }
                            @if (!Model.IsTemplate && Model.HasVariables)
                            {
                                <div class="clearfix"></div>
                                <div class="form-group col-md-6">Устав должен быть либо определен как Шаблон, либо всем Переменным должны быть заданы значения.</div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
        @if (ViewBag.IsAuthor)
        {
            <div id="panel_editors" class="tab-pane fade">
                <div class="col-md-8">
                    <h2>Редакторы Устава</h2>
                </div>
                <div class="clearfix"></div>
                <div class="form-group col-md-6">
                    <table id="editorsGrid" class="table table-striped table-bordered" style="width:100%">
                        <thead class="text-center">
                            <tr>
                                <th>Список редакторов</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach ((int id, string name) in Model.Editors)
                            {
                                <tr>
                                    <td>@name</td>
                                    <td><a asp-action="DeleteEditor" asp-route-typiconId="@Model.Id" asp-route-editorId="@id" title="Delete" data-toggle="tooltip" class="deleteEditor" onclick="return confirm('Вы уверены?')"><i class="material-icons">&#xE872;</i></a></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="clearfix"></div>
                <div class="form-group col-md-6">
                    <label>Поиск по имени или адресу электронной почты</label>
                    <form class="form-inline" method="post" asp-action="AddEditor">
                        <div class="form-group">
                            <input class="form-control" id="searchEditor" placeholder="Имя пользователя или EMail" autocomplete="off">
                            <input type="hidden" id="editorId" name="editorId" />
                        </div>
                        <button class="btn btn-primary" id="addEditor" disabled="disabled" asp-action="AddEditor" asp-route-typiconId="@Model.Id">Добавить</button>
                    </form>
                </div>
            </div>
        }
        <div id="panel_vars" class="tab-pane fade">
            @await Html.PartialAsync((Model.IsTemplate) ? "_TemplateVariables" : "_Variables")
        </div>
    </div>
</div>
@section Scripts
                {

    <link href="https://cdn.datatables.net/responsive/2.1.1/css/responsive.bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="~/css/itemtext.css" />

    <script type="text/javascript" src="https://cdn.rawgit.com/bassjobsen/Bootstrap-3-Typeahead/master/bootstrap3-typeahead.min.js"></script>
    @*<link rel="Stylesheet" href="https://twitter.github.io/typeahead.js/css/examples.css" />*@

    <script src="~/js/itemtext.js"></script>

    <script type="text/javascript">

        $(document).ready(function () {
            createItemTextTable("#itemtext", "Name");

            if (window.location.hash != "") {
                $('a[href="' + window.location.hash + '"]').click()
            }

            $('#searchEditor').typeahead({
                hint: true,
                highlight: true,
                minLength: 1,
                source: function (request, response) {
                    $.ajax({
                        url: '/Typicons/SearchUsers?search=' + request,
                        dataType: "json",
                        type: "POST",
                        contentType: "application/json; charset=utf-8",
                        success: function (data) {
                            items = [];
                            map = {};
                            $.each(data, function (i, item) {
                                map[item.Name] = item;
                                items.push(item.Name);
                            });
                            response(items);
                            //$(".dropdown-menu").css("height", "auto");
                        },
                        error: function (response) {
                            alert(response.responseText);
                        },
                        failure: function (response) {
                            alert(response.responseText);
                        }
                    });
                },
                updater: function (item) {
                    $('#editorId').val(map[item].Id);
                    $('#addEditor').removeAttr("disabled");
                    return item;
                }
            });
            $('#searchEditor').on("input", function () {
                $('#editorId').removeAttr("value");
                $('#addEditor').attr("disabled", "disabled");
            });

            $(function () {


            });
        });

    </script>
}